import socket

import requests

from routersploit import (
    exploits,
    print_success,
    print_status,
    print_error,
    mute,
    shell
)


class Exploit(exploits.Exploit):
    """
    Search if encryption is enabled in this telnet server.
    Some systems implemented encryption incorrectly, so we look if an attack would be possible.
    """
    __info__ = {
        'name': 'Telnet Encryption',
        'description': '',
        'authors': [
            'Dimitri Harkovski <s8ddhark[at]stud.uni-saarland.de>',
            'Tobias Berdin <s8toberd[at]stud.uni-saarland.de>'
        ],
        'references': [
            ''
        ],
        'devices': [
            'Multi',
        ],
    }

    target = exploits.Option('', 'Target address e.g. 192.168.1.1')  # target address

    def run(self):
        if self.check():
            print_success("Encryption is enabled")
        else:
            print_error("Encryption is disabled")

    @mute
    def check(self):
        if self.target == '':
            return False  # target has not been set

        ports = [23]  # common telnet ports for IoT devices
        port = -1

        for p in ports:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            try:
                s.connect((self.target, p))
                port = p
                break
            except:
                continue

        if port == -1:
            # no open port was found
            return False
